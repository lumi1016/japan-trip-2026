<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>2025 關西家族之旅 - 專業導遊版</title>
    
    <!-- 手機 App 圖示與全屏設定 -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/197/197604.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="日本旅遊">

    <!-- 載入核心庫 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&family=Noto+Serif+JP:wght@600;900&family=Ma+Shan+Zheng&display=swap');
        
        :root {
            --kyoto-red: #B22D15;
            --bamboo-green: #3A4D39;
            --osaka-gold: #D4AF37;
            --washi-bg: #F9F6F0;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--washi-bg);
            background-image: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
            color: #2D3436;
            -webkit-tap-highlight-color: transparent;
        }

        .calligraphy { font-family: 'Ma Shan Zheng', cursive !important; }
        
        /* 統一標楷體類別 - 用於詳情頁 */
        .kaity {
            font-family: 'DFKai-SB', '標楷體', 'Kaiti TC', 'KaiTi', serif !important;
        }

        .serif { font-family: 'Noto Serif JP', serif; }
        
        .tab-active { 
            background: var(--kyoto-red) !important; 
            color: white !important; 
            box-shadow: 0 8px 15px rgba(178, 45, 21, 0.3); 
            transform: scale(1.05); 
        }

        .glass-tool { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.6); 
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 1.5rem); }

        .badge-spot { background-color: #EBF5FF; color: #1E40AF; }
        .badge-food { background-color: #FEF2F2; color: #991B1B; }

        .animate-slideUp { animation: slideUp 0.4s cubic-bezier(0, 0, 0.2, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-immersive-header {
            height: 320px;
            background-size: cover;
            background-position: center;
            position: relative;
            background-color: var(--bamboo-green);
        }
        .modal-immersive-overlay {
            background: linear-gradient(to bottom, rgba(249, 246, 240, 0.1) 0%, rgba(249, 246, 240, 0.4) 40%, rgba(249, 246, 240, 0.9) 80%, rgba(249, 246, 240, 1) 100%);
            position: absolute;
            inset: 0;
            z-index: 1;
        }

        .header-title {
            white-space: nowrap;
            overflow: visible;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .text-shadow-premium {
            text-shadow: 0 0 15px rgba(255, 255, 255, 1), 0 0 5px rgba(255, 255, 255, 0.8), 1px 1px 0px rgba(255,255,255,0.5);
        }
    </style>
</head>
<body class="max-w-md mx-auto shadow-2xl min-h-screen pb-48 text-left">

    <!-- 頂部標題區 -->
    <header id="main-header" class="bg-[#3A4D39] text-white p-8 rounded-b-[4rem] shadow-2xl relative overflow-hidden min-h-[190px] flex flex-col justify-end transition-all text-left">
        <img id="header-bg" src="https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=1200&q=80" 
             class="absolute inset-0 w-full h-full object-cover opacity-45 transition-all duration-1000">
        <div class="absolute inset-0 bg-gradient-to-t from-[#3A4D39] via-transparent to-transparent opacity-80"></div>
        <div class="relative z-10 flex justify-between items-end">
            <div class="flex-1 overflow-hidden pb-1 text-left">
                <h1 class="text-4xl font-black calligraphy text-gray-900 leading-none header-title text-left text-shadow-premium">關西慢活之旅</h1>
            </div>
            <div class="text-right flex flex-col items-end">
                <p id="weather-city-name" class="text-7xl calligraphy text-yellow-50 leading-none mb-1 drop-shadow-md">--</p>
                <div class="flex items-center justify-end gap-2 pr-1">
                    <span id="weather-icon-inline" class="text-base opacity-90"></span>
                    <p id="weather-temp-calligraphy" class="text-4xl calligraphy text-yellow-100 leading-none">--°C</p>
                </div>
            </div>
        </div>
    </header>

    <!-- 工具快捷區 -->
    <section class="px-4 -mt-10 relative z-20 flex justify-center gap-2">
        <button onclick="window.toggleTool('calc')" class="w-[31%] glass-tool p-5 rounded-[2rem] shadow-xl flex flex-col items-center active:scale-95 transition-all">
            <i class="fas fa-calculator text-[--osaka-gold] mb-2 text-2xl drop-shadow-sm text-center"></i>
            <span class="text-[10px] font-black text-gray-800 tracking-tighter">匯率換算</span>
        </button>
        <button onclick="window.toggleTool('ledger')" class="w-[31%] glass-tool p-5 rounded-[2rem] shadow-xl flex flex-col items-center active:scale-95 transition-all">
            <i class="fas fa-coins text-emerald-600 mb-2 text-2xl drop-shadow-sm"></i>
            <span class="text-[10px] font-black text-gray-800 tracking-tighter text-center">旅遊記帳</span>
        </button>
        <button onclick="window.toggleTool('trans')" class="w-[31%] glass-tool p-5 rounded-[2rem] shadow-xl flex flex-col items-center active:scale-95 transition-all">
            <i class="fas fa-language text-blue-500 mb-2 text-2xl drop-shadow-sm"></i>
            <span class="text-[10px] font-black text-gray-800 tracking-tighter">翻譯助手</span>
        </button>
    </section>

    <!-- 天氣叮嚀 -->
    <div id="weather-tip" class="px-6 mt-6 hidden text-left">
        <div class="bg-white/80 border-l-4 border-[--kyoto-red] p-4 rounded-r-2xl shadow-sm backdrop-blur-md flex items-center gap-3 text-left">
            <div class="w-10 h-10 rounded-full bg-[--kyoto-red]/10 flex items-center justify-center text-[--kyoto-red] text-sm font-bold">
                <i class="fas fa-info-circle"></i>
            </div>
            <p id="weather-tip-text" class="text-[12px] font-bold text-gray-700 leading-tight"></p>
        </div>
    </div>

    <!-- 日期導覽 -->
    <nav class="flex overflow-x-auto whitespace-nowrap px-4 py-8 no-scrollbar sticky top-0 z-40 bg-[--washi-bg]/95 backdrop-blur-md">
        <div class="flex space-x-4 mx-auto px-4 text-center" id="day-nav-container"></div>
    </nav>

    <!-- 主行程內容 -->
    <main id="main-content" class="px-6 text-left"></main>

    <!-- 詳情彈窗 -->
    <div id="tool-modal" class="hidden fixed inset-0 z-[100] flex items-end justify-center bg-black/60 backdrop-blur-md">
        <div class="bg-[--washi-bg] w-full max-w-md rounded-t-[3rem] shadow-2xl overflow-hidden animate-slideUp max-h-[92vh] flex flex-col relative text-left">
            <button onclick="window.closeModal()" class="absolute top-6 right-6 z-50 w-12 h-12 rounded-full bg-black/40 backdrop-blur-md text-white flex items-center justify-center active:scale-90 transition shadow-lg text-center">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div id="modal-body" class="flex-1 overflow-y-auto no-scrollbar"></div>
        </div>
    </div>

    <!-- 底部導覽 -->
    <footer class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm bg-white/95 backdrop-blur-3xl rounded-[2.5rem] shadow-2xl border border-white p-5 z-50 flex justify-between items-center px-10 safe-pb">
        <a href="tel:09000000000" class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-red-50 text-[--kyoto-red] flex items-center justify-center mb-1 shadow-sm border border-red-100 text-center">
                <i class="fas fa-phone-alt text-xl text-center"></i>
            </div>
            <span class="text-[10px] font-black text-gray-500 uppercase tracking-tighter text-center">聯繫司機</span>
        </a>
        <div class="text-center relative -top-2">
            <div class="relative w-16 h-16 mx-auto text-center text-center">
                <svg class="w-full h-full transform -rotate-90">
                    <circle cx="32" cy="32" r="28" stroke="#f0f0f0" stroke-width="4" fill="transparent" />
                    <circle id="stamina-ring" cx="32" cy="32" r="28" stroke="var(--kyoto-red)" stroke-width="4" fill="transparent" stroke-dasharray="176" stroke-dashoffset="30" class="transition-all duration-1000 ease-in-out" />
                </svg>
                <div class="absolute inset-0 flex items-center justify-center font-black text-[--kyoto-red]">
                    <span id="stamina-val" class="text-sm font-black">--%</span>
                </div>
            </div>
            <span class="text-[10px] font-black text-gray-400 uppercase tracking-widest text-center">家族體力</span>
        </div>
        <a href="https://line.me" class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full bg-green-50 text-green-600 flex items-center justify-center mb-1 shadow-sm border border-green-100 font-black text-center">
                <i class="fab fa-line text-2xl text-center"></i>
            </div>
            <span class="text-[10px] font-black text-gray-500 uppercase tracking-tighter text-center text-center">群組聯繫</span>
        </a>
    </footer>

    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'japan-2025-kansai';
        const apiKey = ""; 

        let currentUser = null;
        let expenses = [];
        let exchangeRate = 0.211;

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'expenses');
                onSnapshot(q, (snapshot) => {
                    expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    expenses.sort((a, b) => b.timestamp - a.timestamp);
                    if (document.getElementById('ledger-total-jpy')) renderLedger();
                });
            }
        });

        initAuth();

        const tourData = {
            1: { 
                label: "大阪・抵達與地標美食", loc: "大阪", engLoc: "Osaka", 
                img: "https://images.unsplash.com/photo-1590559899731-a382839e5549?auto=format&fit=crop&w=1200&q=80", 
                stamina: 85, 
                events: [
                    { t: "09:20", s: "星宇航班 JX822", type: "景點", i: "plane-departure", n: "預計 12:50 抵達 KIX。飛機餐已飽足。", m: "StarLux+JX822", 
                      imgDetail: "https://images.unsplash.com/photo-1436491865332-7a61a109c0f2?auto=format&fit=crop&w=1200&q=80", detailTitle: "星宇航空去程",
                      intro: "開啟家族之旅。精品航空服務體驗。", aiGuide: "資深導遊觀點：領取行李後聯繫司機，下午飯店小憩恢復體力。",
                      mustEat: "機上餐飲。", vegNote: "航空素餐預約。" },
                    { t: "17:30", s: "蟹道樂 (かに道楽) 總店", type: "餐廳", i: "utensils", n: "地標螃蟹宴。預約 17:30 窗邊位。", m: "Kani+Doraku+Honten", 
                      imgDetail: "https://i.ibb.co/XZcYVWYz/image.jpg", detailTitle: "蟹道樂 總店",
                      intro: "道頓堀標誌，清淡精緻螃蟹料理。", aiGuide: "資深導遊觀點：螃蟹刺身與釜飯最適合長輩胃口，窗邊美景無價。",
                      mustEat: "螃蟹釜飯。", vegNote: "有野菜壽司。" },
                    { t: "19:30", s: "Mouriya (モーリヤ) 神戶牛", type: "餐廳", i: "utensils", n: "極致和牛體驗。震撼開場。", m: "Mouriya+Steak+Osaka", 
                      imgDetail: "https://i.ibb.co/N278SDQS/image.jpg", detailTitle: "神戶牛",
                      intro: "創業 130 年的名店。職人現場鐵板工藝展現最高境界。", aiGuide: "資深導遊觀點：幫長輩點『腓力』套餐。質地全牛最軟嫩。",
                      mustEat: "神戶牛腓力。", vegNote: "精緻野菜鐵板燒。" },
                    { t: "21:00", s: "美津の (Mizuno) 大阪燒", type: "餐廳", i: "utensils", n: "米其林推薦。代排策略大公開。", m: "Mizuno+Okonomiyaki", 
                      imgDetail: "https://i.ibb.co/fGPrWmPB/image.jpg", detailTitle: "美津の 大阪燒",
                      intro: "傳承三代米其林名店，以鬆軟山藥粉麵糊與豐富海鮮著稱。", aiGuide: "資深導遊觀點：派年輕人先抽號碼牌。若等太久改找空間大的『千房』。",
                      mustEat: "招牌山藥燒。", vegNote: "可點野菜燒。" },
                    { t: "22:00", s: "三月草莓與宵夜採購", type: "景點", i: "shopping-cart", n: "限定：淡雪古都華草莓與老爺爺宵夜。", m: "Takashimaya+Osaka", 
                      imgDetail: "https://i.ibb.co/qwJrr50/image.jpg", detailTitle: "三月草莓與宵夜",
                      intro: "三月正是草莓最香甜的時刻。高島屋地下街是宵夜寶庫。", aiGuide: "資深導遊觀點：買『古都華』草莓！老爺爺蛋糕帶回飯店微波 10 秒最棉柔。",
                      mustEat: "古都華草莓、551肉包。", vegNote: "水果與蛋糕是素食首選。" }
                ] 
            },
            2: { label: "影城・夢幻之旅", loc: "大阪", engLoc: "Osaka", img: "https://i.ibb.co/Fb2MnJ7h/image.jpg", stamina: 40, events: [{ t: "09:00", s: "環球影城 USJ", type: "景點", i: "ticket-alt", n: "全日活動。善用輪椅服務。", m: "Universal+Studios+Japan", imgDetail: "https://images.unsplash.com/photo-1624316812891-b3b3a6230919?auto=format&fit=crop&w=1200&q=80", intro: "瑪利歐與哈利波特。", aiGuide: "資深導遊觀點：三根掃帚露台拍城堡最美。", mustEat: "奶油啤酒。", vegNote: "有蔬食麵。" }] },
            3: { 
                label: "奈良宇治・神鹿與平等院", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/Rp5Zt2vJ/image.jpg", stamina: 75, 
                events: [
                    { t: "10:30", s: "東大寺與奈良公園", type: "景點", i: "hippo", n: "千年大佛震撼，坐在長椅餵鹿。", m: "Todaiji+Temple", imgDetail: "https://i.ibb.co/ksgDLctq/image.jpg", detailTitle: "東大寺與奈良公園",
                      intro: "大佛殿世界最大。奈良公園有1200頭神鹿。", aiGuide: "資深導遊觀點：長輩可坐在長椅餵鹿，東大寺有無障礙坡道。", mustEat: "鹿餅。", vegNote: "葛粉料理極健康。" },
                    { t: "13:00", s: "奈良午餐美食", type: "餐廳", i: "bowl-rice", n: "志津香釜飯或老街精緻定食。", m: "Shizuka+Nara", imgDetail: "https://i.ibb.co/hRXB7hKW/image.jpg", detailTitle: "奈良 午餐推薦",
                      intro: "現點現煮溫潤釜飯。", aiGuide: "資深導遊觀點：現煮軟糯暖胃。派年輕人先領號碼牌。", mustEat: "七種釜飯。", vegNote: "有野菜套餐。" },
                    { t: "15:30", s: "宇治平等院", type: "景點", i: "torii-gate", n: "鳳凰堂美景，10圓硬幣上的美學。", m: "Byodoin", imgDetail: "https://i.ibb.co/vx1ptgT0/image.jpg", detailTitle: "宇治 平等院",
                      intro: "世界遺產對稱美學。萬元鈔票標誌。", aiGuide: "資深導遊觀點：拿出硬幣對照。步道平緩適合散步。", mustEat: "抹茶甜點。", vegNote: "全素茶泡飯。" }
                ] 
            },
            4: { 
                label: "京都・精華散策與分流", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/PzY0SDLD/image.jpg", stamina: 60, 
                events: [
                    { t: "09:30", s: "清水寺參拜", type: "景點", i: "torii-gate", n: "趁人潮未巔峰賞清水舞台。", m: "Kiyomizu-dera", imgDetail: "https://i.ibb.co/8nLR731B/image.jpg", detailTitle: "清水寺",
                      intro: "木造工藝傑作。名水保佑平安。", aiGuide: "資深導遊觀點：由茶碗坂往走下最省膝蓋力。", mustEat: "生八橋。", vegNote: "奧丹豆腐。" },
                    { t: "11:30", s: "祇園與花見小路", type: "景點", i: "camera", n: "町家風情漫步拍照，享用午餐。", m: "Gion+Hanamikoji", imgDetail: "https://i.ibb.co/BKT0rMnc/image.jpg", detailTitle: "祇園 花見小路",
                      intro: "代表性花街。禁止隨意拍攝舞妓。", aiGuide: "資深導遊觀點：中午在料亭恢復元氣。", mustEat: "黑糖蕨餅。", vegNote: "湯葉料理。" },
                    { t: "14:00", s: "金閣寺 (鹿苑寺)", type: "景點", i: "sun", n: "視覺震撼舍利殿，絕美倒影。", m: "Kinkakuji", imgDetail: "https://i.ibb.co/nN541XSx/image.jpg", detailTitle: "金閣寺",
                      intro: "金箔舍利殿倒映鏡湖池。", aiGuide: "資深導遊觀點：步道平坦，入口處即最佳拍照位。", mustEat: "抹茶與和菓子。", vegNote: "附近有炙燒麻糬。" },
                    { t: "15:30", s: "錦市場 或 鴨川散策", type: "景點", i: "shopping-basket", n: "年輕人逛街，長輩鴨川下午茶。", m: "Nishiki+Market", imgDetail: "https://i.ibb.co/ymfdnwYS/image.jpg", detailTitle: "錦市場 與 鴨川",
                      intro: "京都廚房與親水綠地。", aiGuide: "資深導遊觀點：年輕人採買，長輩在鴨川邊喝咖啡休息。", mustEat: "豆乳甜甜圈。", vegNote: "醃漬野菜豐富。" }
                ] 
            },
            5: { label: "嵐山・竹林深處", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/JFxL6W1q/image.jpg", stamina: 65, events: [{ t: "10:00", s: "嵐山小火車", type: "景點", i: "train", n: "賞溪。推薦 5 號開放式車廂。", m: "Saga-Arashiyama", imgDetail: "https://i.ibb.co/lY7W6wc/image.jpg", intro: "火車觀光賞溪谷。", aiGuide: "資深導遊觀點：長輩看景最輕鬆。", mustEat: "豆腐霜淇淋。", vegNote: "天龍寺篩月。" }] },
            6: { label: "回程・完美賦歸", loc: "京都", engLoc: "Kyoto", img: "https://i.ibb.co/ccRs1FZB/image.jpg", stamina: 90, events: [{ t: "10:00", s: "京都車站採買", type: "景點", i: "shopping-bag", n: "最後補貨。班機 JX823 歸國。", m: "Kyoto+Station", imgDetail: "https://images.unsplash.com/photo-1528164344705-4754268799af?auto=format&fit=crop&w=1200&q=80", intro: "帶回滿滿回憶。", aiGuide: "資深導遊觀點：提早 2.5 小時到機場。", mustEat: "抹茶凍。", vegNote: "全素擔擔麵。" }] }
        };

        // UI 核心邏輯
        const getWeatherData = async (cityName, engLoc) => {
            const coords = engLoc === "Osaka" ? "latitude=34.69&longitude=135.50" : "latitude=35.01&longitude=135.77";
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?${coords}&current_weather=true`);
                const data = await res.json();
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
                let icon = "fa-sun";
                if (code >= 1 && code <= 3) icon = "fa-cloud-sun";
                else if (code >= 51) icon = "fa-cloud-showers-heavy";
                document.getElementById('weather-city-name').innerText = cityName;
                document.getElementById('weather-icon-inline').innerHTML = `<i class="fas ${icon}"></i>`;
                document.getElementById('weather-temp-calligraphy').innerText = `${temp}°C`;
                const tipBox = document.getElementById('weather-tip');
                const tipText = document.getElementById('weather-tip-text');
                if (temp < 15) { tipBox.classList.remove('hidden'); tipText.innerText = `導遊叮嚀：${cityName} 目前氣溫 ${temp}°C，長輩請穿厚外套防風。`; }
                else if (code >= 51) { tipBox.classList.remove('hidden'); tipText.innerText = `導遊叮嚀：${cityName} 今日有雨，請準備雨具。`; }
                else { tipBox.classList.add('hidden'); }
            } catch (e) { console.error("Weather Error", e); }
        };

        window.toggleTool = (type, day, idx) => {
            const modal = document.getElementById('tool-modal');
            const body = document.getElementById('modal-body');
            modal.classList.remove('hidden');
            body.innerHTML = '';
            if (type === 'calc') {
                body.innerHTML = `<div class="p-10 text-left"><h3 class="text-3xl font-black calligraphy mb-6 text-gray-900 text-shadow-premium">匯率換算</h3><div class="mb-4 bg-yellow-50 p-4 rounded-3xl text-center border border-yellow-100 text-left text-center"><p class="text-[11px] font-black text-yellow-700 uppercase">即時參考匯率</p><p class="text-xl font-bold mt-1 font-mono">${window.liveRateText || '載入中...'}</p></div><div class="mb-8 text-left text-left"><label class="text-[12px] font-black text-gray-400 uppercase block mb-1 text-left">輸入日圓 (JPY)</label><input type="number" id="jpy-input" class="w-full text-5xl font-black border-b-2 py-3 outline-none text-left" oninput="window.runConversion()" placeholder="¥"></div><div><label class="text-[12px] font-black text-gray-400 uppercase block mb-1 text-left">約台幣 (TWD)</label><p id="twd-output" class="text-6xl font-black text-[--kyoto-red] mt-2 tracking-tighter text-left">0</p></div></div>`;
            } else if (type === 'ledger') {
                body.innerHTML = `<div class="p-8 text-center text-left text-left"><h3 class="text-3xl font-black calligraphy mb-8 text-gray-900 text-shadow-premium text-center">家族公用金</h3><div class="bg-emerald-50 p-8 rounded-[3rem] mb-8 border border-emerald-100 text-left"><p class="text-[12px] font-black text-emerald-800 uppercase mb-1 text-center font-bold">每人分攤 (8位)</p><p id="ledger-total-jpy" class="text-4xl font-black text-emerald-900 text-center font-black">¥ 0</p><p id="ledger-split-amount" class="text-lg font-bold text-[--kyoto-red] mt-2 text-center font-bold">每人: ¥ 0</p></div><div class="flex gap-3 mb-8"><input type="text" id="ledger-item-name" placeholder="品項" class="flex-1 bg-gray-100 rounded-3xl p-5 text-lg font-bold outline-none"><input type="number" id="ledger-item-amount" placeholder="¥" class="w-28 bg-gray-100 rounded-2xl p-4 text-sm font-bold outline-none"><button onclick="window.addExpense()" class="bg-emerald-600 text-white px-6 rounded-2xl font-black active:scale-95 transition">加</button></div><div id="ledger-list" class="space-y-4"></div></div>`;
                renderLedger();
            } else if (type === 'trans') {
                body.innerHTML = `<div class="p-10 text-left text-left text-left text-left"><h3 class="text-3xl font-black calligraphy mb-8 text-gray-900 text-shadow-premium text-left">AI 翻譯助手</h3><textarea id="trans-text" rows="3" placeholder="請輸入中文..." class="w-full bg-gray-100 rounded-[2.5rem] p-7 text-xl font-bold mb-8 outline-none focus:ring-2 ring-[--kyoto-red]/20 text-left"></textarea><button onclick="window.askAI()" id="ai-btn" class="w-full bg-blue-600 text-white py-6 rounded-[2.5rem] font-black shadow-lg flex items-center justify-center gap-3 transition active:scale-95 text-xl font-bold"><span>開始翻譯</span></button><div id="ai-result" class="mt-10 p-8 bg-blue-50 rounded-[2.5rem] hidden border border-blue-100 shadow-inner relative text-left text-left"><div class="flex justify-between items-start text-left text-left text-left"><div class="flex-1 text-left text-left"><p id="res-jp" class="text-3xl font-black text-blue-900 leading-tight text-left"></p><p id="res-romaji" class="text-sm text-blue-400 italic mt-4 font-bold text-left"></p></div><button onclick="window.speakJP(document.getElementById('res-jp').innerText)" class="w-14 h-14 rounded-full bg-white text-blue-600 shadow-md flex items-center justify-center active:scale-90 transition-all ml-4 flex-shrink-0 text-center"><i class="fas fa-volume-up text-xl text-center"></i></button></div></div></div>`;
            } else if (type === 'detail') {
                const data = tourData[day].events[idx];
                const displayTitle = data.detailTitle || data.s;
                body.innerHTML = `
                    <div class="modal-immersive-header" style="background-image: url('${data.imgDetail}')">
                        <div class="modal-immersive-overlay"></div>
                        <div class="absolute bottom-8 left-10 right-10 z-10 text-left">
                            <span class="${data.type === '景點' ? 'badge-spot' : 'badge-food'} text-[11px] font-black px-5 py-2 rounded-full shadow-sm mb-4 inline-block uppercase tracking-widest font-bold">${data.type}</span>
                            <h2 class="text-4xl font-black text-gray-900 kaity leading-tight tracking-tight text-left header-title text-shadow-premium">${displayTitle}</h2>
                        </div>
                    </div>
                    <div class="px-10 pb-16 pt-8 space-y-10 text-left">
                        <section><h4 class="text-2xl font-black text-gray-900 kaity border-l-4 border-[--kyoto-red] pl-4 mb-4 tracking-widest">深度解析與歷史</h4><p class="text-[15px] text-gray-600 leading-relaxed text-justify">${data.intro}</p></section>
                        <section class="bg-white p-7 rounded-[2.5rem] shadow-sm border border-gray-100"><div class="flex items-center gap-3 mb-4 text-[--kyoto-red] text-left"><i class="fas fa-magic text-sm"></i><h4 class="text-2xl font-black text-gray-900 kaity tracking-widest font-bold">資深導遊觀點</h4></div><p class="text-[15px] text-gray-800 leading-relaxed font-bold italic">${data.aiGuide}</p></section>
                        <section><h4 class="text-2xl font-black text-gray-900 kaity border-l-4 border-[--osaka-gold] pl-4 mb-4 tracking-widest">${data.type === '餐廳' ? '推薦必點' : '行程叮嚀'}</h4><div class="bg-[--osaka-gold]/5 p-6 rounded-[2.5rem] border border-[--osaka-gold]/10 text-left"><p class="text-sm text-yellow-900 leading-relaxed font-black">${data.mustEat || data.n}</p></div></section>
                        ${data.vegNote ? `<section class="bg-emerald-50 p-7 rounded-[2.5rem] border border-emerald-100 text-left"><div class="flex items-center gap-3 mb-4 text-emerald-800 text-left font-bold"><i class="fas fa-leaf text-sm text-left text-left"></i><h4 class="text-2xl font-black text-gray-900 kaity tracking-widest font-bold">素食同行者指南</h4></div><p class="text-[14px] text-emerald-900 leading-relaxed text-left font-bold">${data.vegNote}</p></section>` : ''}
                        <a href="https://www.google.com/maps/search/?api=1&query=${data.m}" target="_blank" class="block w-full py-6 bg-gray-900 text-white rounded-[2.5rem] text-center text-lg font-black shadow-2xl active:scale-95 transition tracking-widest kaity">開啟地圖導覽</a>
                    </div>`;
            }
        };

        window.closeModal = () => document.getElementById('tool-modal').classList.add('hidden');
        window.runConversion = () => {
            const jpy = document.getElementById('jpy-input').value;
            document.getElementById('twd-output').innerText = (jpy * exchangeRate).toLocaleString('zh-TW', {maximumFractionDigits: 1});
        };

        window.addExpense = async () => {
            if (!currentUser) return;
            const name = document.getElementById('ledger-item-name').value;
            const amount = parseFloat(document.getElementById('ledger-item-amount').value);
            if (!name || isNaN(amount)) return;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), {
                    name, amount, timestamp: Date.now(), timeStr: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                document.getElementById('ledger-item-name').value = '';
                document.getElementById('ledger-item-amount').value = '';
            } catch (e) { console.error("Add Error", e); }
        };

        window.deleteExpense = async (id) => {
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id)); } 
            catch (e) { console.error("Delete Error", e); }
        };

        const renderLedger = () => {
            const list = document.getElementById('ledger-list');
            if (!list) return;
            const totalJPY = expenses.reduce((sum, item) => sum + item.amount, 0);
            const splitJPY = Math.round(totalJPY / 8);
            document.getElementById('ledger-total-jpy').innerText = `¥ ${totalJPY.toLocaleString()}`;
            document.getElementById('ledger-split-amount').innerText = `每人應繳: ¥ ${splitJPY.toLocaleString()}`;
            list.innerHTML = expenses.map(item => `
                <div class="flex justify-between items-center bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100 font-bold">
                    <div class="flex-1 text-left">
                        <p class="text-lg text-gray-800 kaity">${item.name}</p>
                        <p class="text-[10px] text-gray-400">${item.timeStr || ''}</p>
                    </div>
                    <div class="text-right flex items-center gap-4 text-right">
                        <p class="text-lg text-[--kyoto-red]">¥ ${item.amount.toLocaleString()}</p>
                        <button onclick="window.deleteExpense('${item.id}')" class="text-gray-300 active:text-red-500 transition px-2">
                            <i class="fas fa-trash-alt text-sm text-right"></i>
                        </button>
                    </div>
                </div>`).join('');
        };

        window.askAI = async () => {
            const text = document.getElementById('trans-text').value;
            const btn = document.getElementById('ai-btn'); const resBox = document.getElementById('ai-result');
            if (!text) return;
            btn.disabled = true; btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>';
            const sysMsg = "你是一位專業日本導遊。將中文翻譯成日文並提供羅馬拼音。回應格式：JSON { 'jp': '...', 'roma': '...' }。";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: text }] }], systemInstruction: { parts: [{ text: sysMsg }] }, generationConfig: { responseMimeType: "application/json" } })
                });
                const data = await response.json(); const jsonRes = JSON.parse(data.candidates[0].content.parts[0].text);
                document.getElementById('res-jp').innerText = jsonRes.jp; document.getElementById('res-romaji').innerText = `發音: ${jsonRes.roma}`;
                resBox.classList.remove('hidden');
            } catch (e) { console.error(e); }
            finally { btn.disabled = false; btn.innerHTML = '<span>開始翻譯</span>'; }
        };

        window.speakJP = (text) => {
            const msg = new SpeechSynthesisUtterance(text); msg.lang = 'ja-JP'; msg.rate = 0.9; window.speechSynthesis.speak(msg);
        };

        window.switchDay = (d) => {
            document.querySelectorAll('#day-nav-container button').forEach(b => b.classList.remove('tab-active'));
            const tab = document.getElementById(`tab${d}`);
            if (tab) tab.classList.add('tab-active');
            const data = tourData[d];
            const headerImg = document.getElementById('header-bg');
            headerImg.style.opacity = '0';
            setTimeout(() => {
                headerImg.src = data.img;
                headerImg.style.opacity = '0.45';
            }, 300);
            
            // 呼叫天氣抓取函數
            getWeatherData(data.loc, data.engLoc); 
            
            const dash = 176 - (176 * data.stamina / 100);
            document.getElementById('stamina-ring').style.strokeDashoffset = dash;
            document.getElementById('stamina-val').innerText = data.stamina + '%';
            
            let html = `<div class="fade-in">`;
            data.events.forEach((e, idx) => {
                const badgeClass = e.type === '景點' ? 'badge-spot' : 'badge-food';
                html += `
                <div class="relative pl-8 mb-10 border-l-2 border-dashed border-gray-200 text-left" onclick="window.toggleTool('detail', ${d}, ${idx})">
                    <div class="absolute -left-2 top-0 w-4 h-4 rounded-full bg-[--kyoto-red] border-4 border-white shadow-md text-center"></div>
                    <div class="bg-white rounded-[2.5rem] p-8 shadow-lg border border-gray-50 active:scale-[0.98] transition">
                        <div class="flex justify-between items-center mb-5 text-left text-left">
                            <span class="bg-[--bamboo-green] text-white text-[10px] px-4 py-1.5 rounded-full font-bold shadow-sm text-center">${e.t}</span>
                            <span class="${badgeClass} text-[9px] font-bold px-3 py-1 rounded-lg shadow-inner font-bold text-center">${e.type}</span>
                        </div>
                        <h3 class="text-2xl font-black text-gray-800 mb-3 flex items-center serif tracking-tight text-left font-black">
                            <i class="fas fa-${e.i} mr-4 text-[--kyoto-red] text-xl text-center"></i> ${e.s}
                        </h3>
                        <p class="text-[14px] text-gray-500 mb-5 leading-relaxed font-bold line-clamp-1 text-left text-left">${e.n}</p>
                        <div class="bg-red-50 text-[--kyoto-red] px-5 py-3 rounded-3xl text-[11px] font-bold border border-red-100 flex items-center justify-between shadow-sm text-left">
                            <span class="text-left font-bold text-left text-left"><i class="fas fa-search-plus mr-3 opacity-50 text-sm"></i> 深度導覽與實景圖</span>
                            ${e.vegNote ? '<i class="fas fa-leaf text-emerald-600 text-sm text-right"></i>' : ''}
                        </div>
                    </div>
                </div>`;
            });
            document.getElementById('main-content').innerHTML = html + `</div>`;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.onload = async () => {
            try {
                const res = await fetch('https://open.er-api.com/v6/latest/JPY');
                const d = await res.json();
                exchangeRate = d.rates.TWD;
                window.liveRateText = `1 JPY = ${exchangeRate.toFixed(3)} TWD`;
            } catch (e) { window.liveRateText = `1 JPY = 0.211 TWD`; }
            
            const nav = document.getElementById('day-nav-container');
            const dayNames = ["第一日", "第二日", "第三日", "第四日", "第五日", "第六日"];
            for(let i=1; i<=6; i++) {
                nav.innerHTML += `<button onclick="window.switchDay(${i})" id="tab${i}" class="px-8 py-3.5 rounded-[1.8rem] bg-white text-gray-400 shadow-sm border border-gray-100 font-bold transition-all text-sm">${dayNames[i-1]}</button>`;
            }
            window.switchDay(1);
        };
    </script>
</body>
</html>
